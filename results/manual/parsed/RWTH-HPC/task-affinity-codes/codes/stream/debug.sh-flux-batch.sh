#!/bin/bash
#FLUX: --job-name=STREAM_TASK_AFFINITY_TEST
#FLUX: --exclusive
#FLUX: --queue=c16s
#FLUX: -t=60
#FLUX: --priority=16

export KMP_TASK_STEALING_CONSTRAINT='0'
export OMP_PLACES='cores'
export OMP_PROC_BIND='spread'
export OMP_NUM_THREADS='16'
export T_AFF_INVERTED='0'
export THIRD_INVERTED='0'
export T_AFF_SINGLE_CREATOR='1'
export T_AFF_NUM_TASK_MULTIPLICATOR='16'
export STREAM_ARRAY_SIZE='$((2**30))'
export TASK_AFF_THREAD_SELECTION_STRATEGY='2'
export TASK_AFF_AFFINITY_MAP_MODE='1'
export TASK_AFF_PAGE_SELECTION_MODE='0'
export TASK_AFF_PAGE_WEIGHTING_STRATEGY='0'
export TASK_AFF_NUMBER_OF_AFFINITIES='20'
export TASK_AFF_THRESHOLD='0.3'

module unload omp
make clean
module use -a ~/.modules
module load omp/task_aff.deb
module load intelvtune
module load ddt
make deb.affinity
export KMP_TASK_STEALING_CONSTRAINT=0
export OMP_PLACES=cores
export OMP_PROC_BIND=spread
export OMP_NUM_THREADS=16
export T_AFF_INVERTED=0
export THIRD_INVERTED=0
export T_AFF_SINGLE_CREATOR=1
export T_AFF_NUM_TASK_MULTIPLICATOR=16
export STREAM_ARRAY_SIZE=$((2**30))
export TASK_AFF_THREAD_SELECTION_STRATEGY=2
export TASK_AFF_AFFINITY_MAP_MODE=0
export TASK_AFF_PAGE_SELECTION_MODE=0
export TASK_AFF_PAGE_WEIGHTING_STRATEGY=1
export TASK_AFF_NUMBER_OF_AFFINITIES=20
export TASK_AFF_THREAD_SELECTION_STRATEGY=2
export TASK_AFF_AFFINITY_MAP_MODE=1
export TASK_AFF_PAGE_SELECTION_MODE=0
export TASK_AFF_PAGE_WEIGHTING_STRATEGY=0
export TASK_AFF_NUMBER_OF_AFFINITIES=20
export TASK_AFF_THRESHOLD=0.3
ddt
