#!/bin/bash
#FLUX: --job-name=adorable-despacito-3648
#FLUX: --priority=16

export OMP_NUM_THREADS='${NTHREADS}'
export AFF_THREAD='${NTHREADS}'
export KMP_AFFINITY='compact'
export I_MPI_TUNING_BIN='${I_MPI_ROOT}/intel64/etc/tuning_skx_shm-ofi_efa.dat'
export VT_ACTIVITY='SYSTEM ON'
export VT_PCTRACE='1'
export VT_LOGFILE_PREFIX='${ITAC_RESULTS_PATH}/${EXPERIMENT_RESULTS_DIR}'
export VT_LOGFILE_FORMAT='STF #[ASCII|STF|STFSINGLE|SINGLESTF]'

START_TIME=`date '+%Y-%b-%d_%H.%M.%S'`
PROFILING_RESULTS_PATH=PROFILING_RESULTS
ITAC_RESULTS_PATH=${PROFILING_RESULTS_PATH}/ITAC_RESULTS
EXPERIMENT_RESULTS_DIR=ITAC_RESULTS_${START_TIME}_job${SLURM_JOBID}
NUMA_CPU_BIND="0"
NUMA_MEM_BIND="0"
NUMA_CTL_CMD_ARGS="numactl --cpubind=${NUMA_CPU_BIND} --membind=${NUMA_MEM_BIND}"
NNODES=1
NTASKSPERNODE=16
NTHREADS=1
NPROCS=$(( NTASKSPERNODE*NNODES ))
export OMP_NUM_THREADS=${NTHREADS}
export AFF_THREAD=${NTHREADS}
export KMP_AFFINITY=compact
PATH_TO_EXECUTABLE=${QNLP_ROOT}/build/demos/hamming_RotY
EXECUTABLE=exe_demo_hamming_RotY
EXE_VERBOSE=0
EXE_TEST_PATTERN=0
EXE_NUM_EXP=2
EXE_LEN_PATTERNS=12
EXECUTABLE_ARGS="${EXE_VERBOSE} ${EXE_TEST_PATTERN} ${EXE_NUM_EXP} ${EXE_LEN_PATTERNS}"
module load  gcc/8.2.0 intel/2019u5
export I_MPI_TUNING_BIN=${I_MPI_ROOT}/intel64/etc/tuning_skx_shm-ofi_efa.dat
INTEL_PARALLELSTUDIO_PATH=/ichec/packages/intel/2019u5/parallel_studio_xe_2019.5.075/bin
source ${INTEL_PARALLELSTUDIO_PATH}/psxevars.sh
export VT_ACTIVITY=SYSTEM ON
export VT_PCTRACE=1
[ ! -d "${PROFILING_RESULTS_PATH}" ] && mkdir -p "${PROFILING_RESULTS_PATH}"
[ ! -d "${ITAC_RESULTS_PATH}" ] && mkdir -p "${ITAC_RESULTS_PATH}"
[ ! -d "${ITAC_RESULTS_PATH}/${EXPERIMENT_RESULTS_DIR}" ] && mkdir -p "${ITAC_RESULTS_PATH}/${EXPERIMENT_RESULTS_DIR}"
export VT_LOGFILE_PREFIX=${ITAC_RESULTS_PATH}/${EXPERIMENT_RESULTS_DIR}
export VT_LOGFILE_FORMAT=STF #[ASCII|STF|STFSINGLE|SINGLESTF]
start_time=`date +%s`
mpirun -trace -n ${NPROCS} -ppn ${NTASKSPERNODE} ${NUMA_CTL_CMD_ARGS} ${PATH_TO_EXECUTABLE}/${EXECUTABLE} ${EXECUTABLE_ARGS}
end_time=`date +%s`
runtime=$((end_time-start_time))
echo "Execution time: ${runtime}"
cp slurm-${SLURM_JOBID}.out ${VT_LOGFILE_PREFIX}/slurm-${SLURM_JOBID}.out
