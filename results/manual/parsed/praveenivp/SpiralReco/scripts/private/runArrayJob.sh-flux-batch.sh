#!/bin/bash
#FLUX: --job-name=pusheena-pedo-7234
#FLUX: -c=16
#FLUX: --exclusive
#FLUX: --queue=compute
#FLUX: -t=86400
#FLUX: --urgency=16

export OMP_NUM_THREADS='16'
export SINGULARITYENV_OMP_NUM_THREADS='16'
export SINGULARITYENV_SLURM_ARRAY_TASK_MIN='$SLURM_ARRAY_TASK_MIN'
export SINGULARITYENV_SLURM_ARRAY_TASK_MAX='$SLURM_ARRAY_TASK_MAX'
export SINGULARITYENV_SLURM_ARRAY_TASK_ID='$SLURM_ARRAY_TASK_ID'
export SINGULARITYENV_SLURM_ARRAY_TASK_COUNT='$SLURM_ARRAY_TASK_COUNT'
export SINGULARITYENV_SPIRAL_FN='$1 '
export SINGULARITYENV_B0MODE='$2'

module purge
module load singularity
export OMP_NUM_THREADS=16
export SINGULARITYENV_OMP_NUM_THREADS=16
export SINGULARITYENV_SLURM_ARRAY_TASK_MIN=$SLURM_ARRAY_TASK_MIN
export SINGULARITYENV_SLURM_ARRAY_TASK_MAX=$SLURM_ARRAY_TASK_MAX
export SINGULARITYENV_SLURM_ARRAY_TASK_ID=$SLURM_ARRAY_TASK_ID
export SINGULARITYENV_SLURM_ARRAY_TASK_COUNT=$SLURM_ARRAY_TASK_COUNT
export SINGULARITYENV_SPIRAL_FN=$1 
export SINGULARITYENV_B0MODE=$2
scriptloc=$(pwd)
command="cd $scriptloc; ArrayScript;"
srun singularity run -B /ptmp /ptmp/pvalsala/MyContainers/matlab-2021a-patch.sif -nodisplay -batch "$command"
mkdir -p logs/$SLURM_ARRAY_JOB_ID
mv job.*$SLURM_ARRAY_JOB_ID*$SLURM_ARRAY_TASK_ID logs/$SLURM_ARRAY_JOB_ID/
