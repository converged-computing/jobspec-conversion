#!/bin/bash
#FLUX: --job-name=deduplicate_clipoverlap
#FLUX: --priority=16

echo $SLURM_JOB_ID
WORKDIR=/workdir/$USER/$SLURM_JOB_ID-$SLURM_ARRAY_TASK_ID/
mkdir -p $WORKDIR
cd $WORKDIR
mkdir bam
BAMDIR_LOCAL=$WORKDIR'bam/'
/programs/bin/labutils/mount_server $SERVER
BAMDIR_MOUNTED=`head $BAMLIST -n 1 | sed 's|\(.*\)/.*|\1|'`/
TOTAL_NUMBER_OF_SAMPLES=`grep -c ".*" $BAMLIST`
QUOTIENT=$((TOTAL_NUMBER_OF_SAMPLES/ARRAY_LENGTH))
REMAINDER=$((TOTAL_NUMBER_OF_SAMPLES%ARRAY_LENGTH))
if [[ $SLURM_ARRAY_TASK_ID -le $REMAINDER ]]; then
  NUMBER_OF_SAMPLES_IN_EACH_ARRAY=$((QUOTIENT+1))
  LINE_START=$((1 + (SLURM_ARRAY_TASK_ID-1)*(NUMBER_OF_SAMPLES_IN_EACH_ARRAY)))
else
  NUMBER_OF_SAMPLES_IN_EACH_ARRAY=$QUOTIENT
  LINE_START=$((1 + (SLURM_ARRAY_TASK_ID-1)*(NUMBER_OF_SAMPLES_IN_EACH_ARRAY) + REMAINDER))
fi
LINE_END=$((LINE_START+NUMBER_OF_SAMPLES_IN_EACH_ARRAY-1))
TEMPORARY_BAM_LIST_LOCAL=$SLURM_ARRAY_TASK_ID.local.txt
TEMPORARY_BAM_LIST_MOUNTED=$SLURM_ARRAY_TASK_ID.mounted.txt
awk "NR >= $LINE_START && NR <= $LINE_END" $BAMLIST > $TEMPORARY_BAM_LIST_MOUNTED
sed 's+'$BAMDIR_MOUNTED'+'$BAMDIR_LOCAL'+g' $TEMPORARY_BAM_LIST_MOUNTED > $TEMPORARY_BAM_LIST_LOCAL
for LINE in `cat $TEMPORARY_BAM_LIST_MOUNTED`; do
  cp $LINE $BAMDIR_LOCAL
done
bash $SCRIPT $TEMPORARY_BAM_LIST_LOCAL $SAMPLETABLE $JAVA $PICARD $BAMUTIL
cp ${BAMDIR_LOCAL}/*_dedup* $BAMDIR_MOUNTED
cp ${BAMDIR_LOCAL}/*_dupstat.txt $BAMDIR_MOUNTED
rm -rf $WORKDIR
